<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Booth CVC YOUTH</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.3.2/gifshot.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;700&family=Kanit:wght@300;500&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #ff7675; --bg: #ffeaa7; --panel: #fff; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        h1 { font-family: 'Mali', cursive; color: #d63031; text-shadow: 2px 2px 0 white; margin-bottom: 10px; }

        /* Camera & Preview Areas */
        .stage { background: #000; border-radius: 15px; overflow: hidden; position: relative; width: 100%; max-width: 480px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        video { width: 100%; height: auto; transform: scaleX(-1); display: block; }
        
        #editor-area { display: none; background: white; padding: 20px; border-radius: 15px; max-width: 600px; width: 100%; box-shadow: 0 10px 20px rgba(0,0,0,0.1); flex-direction: column; align-items: center; }
        
        canvas { max-width: 100%; height: auto; border: 2px solid #eee; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* Controls */
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 15px; width: 100%; }
        .tool-section { border-bottom: 1px dashed #ddd; padding-bottom: 10px; margin-bottom: 10px; width: 100%; text-align: center; }
        .label { font-size: 0.9rem; color: #666; display: block; margin-bottom: 5px; font-weight: bold; }

        button { border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-family: 'Kanit'; font-size: 0.9rem; transition: 0.2s; background: #eee; color: #555; }
        button:hover { background: #ddd; }
        button.active { background: var(--primary); color: white; transform: scale(1.05); }
        button.action-btn { width: 100%; font-size: 1.2rem; padding: 12px; margin-top: 10px; border-radius: 10px; }
        
        .btn-capture { background: #d63031; color: white; font-family: 'Mali'; font-weight: bold; }
        .btn-save { background: #0984e3; color: white; }
        .btn-reset { background: #636e72; color: white; }

        /* QR & Loading */
        #qr-area { display: none; margin-top: 20px; text-align: center; background: #f5f6fa; padding: 15px; border-radius: 10px; width: 100%; }
        #qrcode img { margin: 0 auto; }
        .status { font-size: 0.9rem; color: #d63031; margin-top: 10px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        /* Layout Icons (Simple CSS Shapes) */
        .icon-grid { display: inline-block; width: 16px; height: 16px; background: currentColor; clip-path: polygon(0 0, 45% 0, 45% 45%, 0 45%, 0 0, 55% 0, 100% 0, 100% 45%, 55% 45%, 55% 0, 0 55%, 45% 55%, 45% 100%, 0 100%, 0 55%, 55% 55%, 100% 55%, 100% 100%, 55% 100%, 55% 55%); }
        .icon-strip { display: inline-block; width: 12px; height: 16px; border: 2px solid currentColor; border-top: 4px solid currentColor; border-bottom: 4px solid currentColor; }

        /* Countdown */
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 8rem; color: white; font-family: 'Mali'; text-shadow: 0 0 20px black; display: none; }
    </style>
</head>
<body>

    <h1>üì∏ Valentine Photobooth</h1>

    <div id="camera-page" class="stage">
        <video id="video" autoplay playsinline></video>
        <div id="countdown">3</div>
        <div style="position:absolute; bottom:20px; width:100%; text-align:center;">
            <button class="btn-capture action-btn" onclick="startCameraSequence()" style="width:80%;">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ (4 ‡∏ä‡πá‡∏≠‡∏ï)</button>
        </div>
    </div>

    <div id="editor-area">
        <canvas id="final-canvas"></canvas>

        <div class="tool-section">
            <span class="label">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (Layout)</span>
            <div class="toolbar">
                <button onclick="changeLayout('strip4', this)" class="active">4 ‡∏ä‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏ß</button>
                <button onclick="changeLayout('grid4', this)">4 ‡∏ä‡πà‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
                <button onclick="changeLayout('strip3', this)">3 ‡∏ä‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏ß</button>
                <button onclick="changeLayout('cut2', this)">2 ‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà</button>
            </div>
        </div>

        <div class="tool-section">
            <span class="label">2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (Theme)</span>
            <div class="toolbar">
                <button onclick="changeTheme('none', this)" class="active">‡∏Ñ‡∏•‡∏µ‡∏ô‡πÜ</button>
                <button onclick="changeTheme('love', this)">‡∏ß‡∏≤‡πÄ‡∏•‡∏ô‡πÑ‡∏ó‡∏ô‡πå üíñ</button>
                <button onclick="changeTheme('cute', this)">‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å üß∏</button>
                <button onclick="changeTheme('cool', this)">‡πÄ‡∏ó‡πà‡πÜ üòé</button>
            </div>
        </div>

        <button id="btn-upload" class="btn-save action-btn" onclick="uploadFiles()">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô & ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</button>
        <button class="btn-reset action-btn" onclick="resetBooth()" style="margin-top:10px;">‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>

        <div id="qr-area">
            <div id="qrcode"></div>
            <p id="status-text" class="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...</p>
            <div id="link-buttons" style="display:none; margin-top:10px; gap:10px; justify-content:center;">
                <a id="dl-img" href="#" target="_blank"><button>‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button></a>
                <a id="dl-gif" href="#" target="_blank"><button style="background:#6c5ce7; color:white;">‡∏î‡∏π GIF ‡∏î‡∏∏‡πä‡∏Å‡∏î‡∏¥‡πä‡∏Å</button></a>
            </div>
            <p style="font-size:0.8rem; color:#888; margin-top:5px;">*‡∏™‡πÅ‡∏Å‡∏ô QR ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</p>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const editorArea = document.getElementById('editor-area');
        const cameraPage = document.getElementById('camera-page');
        const canvas = document.getElementById('final-canvas');
        const ctx = canvas.getContext('2d');
        const countdownEl = document.getElementById('countdown');
        const qrArea = document.getElementById('qr-area');
        const statusText = document.getElementById('status-text');
        const btnUpload = document.getElementById('btn-upload');

        let photos = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ 4 ‡∏ä‡πá‡∏≠‡∏ï‡∏ó‡∏µ‡πà‡∏ñ‡πà‡∏≤‡∏¢‡∏°‡∏≤
        let currentLayout = 'strip4';
        let currentTheme = 'none';
        let generatedGIFBlob = null;

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á
        navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } })
            .then(stream => video.srcObject = stream);

        // 1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û (‡∏ñ‡πà‡∏≤‡∏¢ 4 ‡∏£‡∏π‡∏õ‡πÄ‡∏™‡∏°‡∏≠ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô)
        async function startCameraSequence() {
            photos = [];
            document.querySelector('.btn-capture').style.display = 'none';
            
            for (let i = 0; i < 4; i++) {
                await doCountdown(3);
                const shot = captureFrame();
                photos.push(shot);
                
                // Flash Effect
                const flash = document.createElement('div');
                flash.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:white;z-index:99;transition:opacity 0.2s;";
                cameraPage.appendChild(flash);
                setTimeout(() => flash.style.opacity = 0, 50);
                setTimeout(() => flash.remove(), 250);

                if (i < 3) await new Promise(r => setTimeout(r, 1000));
            }

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° GIF ‡πÑ‡∏ß‡πâ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á
            createGIF();

            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ Editor
            cameraPage.style.display = 'none';
            editorArea.style.display = 'flex';
            renderCanvas(); // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å
        }

        function captureFrame() {
            const tCanvas = document.createElement('canvas');
            tCanvas.width = video.videoWidth;
            tCanvas.height = video.videoHeight;
            const tCtx = tCanvas.getContext('2d');
            tCtx.translate(tCanvas.width, 0);
            tCtx.scale(-1, 1);
            tCtx.drawImage(video, 0, 0);
            return tCanvas;
        }

        function doCountdown(sec) {
            return new Promise(resolve => {
                countdownEl.style.display = 'block';
                let c = sec;
                countdownEl.innerText = c;
                const timer = setInterval(() => {
                    c--;
                    if (c > 0) countdownEl.innerText = c;
                    else { clearInterval(timer); countdownEl.style.display = 'none'; resolve(); }
                }, 1000);
            });
        }

        // 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏≤‡∏î Layout (Editor Core)
        function renderCanvas() {
            const padding = 30;
            const gap = 15;
            const imgW = 640;
            const imgH = 480;
            
            let totalW, totalH;

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡∏ï‡∏≤‡∏° Layout
            if (currentLayout === 'strip4') {
                totalW = imgW + (padding * 2);
                totalH = (imgH * 4) + (gap * 3) + (padding * 2) + 100;
            } else if (currentLayout === 'grid4') {
                totalW = (imgW * 2) + gap + (padding * 2);
                totalH = (imgH * 2) + gap + (padding * 2) + 100;
            } else if (currentLayout === 'strip3') {
                totalW = imgW + (padding * 2);
                totalH = (imgH * 3) + (gap * 2) + (padding * 2) + 100;
            } else if (currentLayout === 'cut2') {
                totalW = imgW + (padding * 2);
                totalH = (imgH * 2) + gap + (padding * 2) + 100;
            }

            canvas.width = totalW;
            canvas.height = totalH;

            // ‡πÄ‡∏ó‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
            ctx.fillStyle = (currentTheme === 'love') ? '#fab1a0' : 
                            (currentTheme === 'cool') ? '#2d3436' :
                            (currentTheme === 'cute') ? '#ffeaa7' : 'white';
            ctx.fillRect(0, 0, totalW, totalH);

            // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
            photos.forEach((img, i) => {
                let x, y;
                
                if (currentLayout === 'strip4') {
                    x = padding;
                    y = padding + (i * (imgH + gap));
                } else if (currentLayout === 'grid4') {
                    let row = Math.floor(i / 2);
                    let col = i % 2;
                    x = padding + (col * (imgW + gap));
                    y = padding + (row * (imgH + gap));
                } else if (currentLayout === 'strip3') {
                    if (i > 2) return; // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 3 ‡∏£‡∏π‡∏õ
                    x = padding;
                    y = padding + (i * (imgH + gap));
                } else if (currentLayout === 'cut2') {
                    if (i > 1) return; // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 2 ‡∏£‡∏π‡∏õ
                    x = padding;
                    y = padding + (i * (imgH + gap));
                }

                // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏•‡πá‡∏Å‡πÜ
                ctx.fillStyle = 'white';
                ctx.fillRect(x - 5, y - 5, imgW + 10, imgH + 10);
                ctx.drawImage(img, x, y, imgW, imgH);
            });

            // ‡∏ß‡∏≤‡∏î Decorations (Theme)
            drawDecorations(totalW, totalH);

            // ‡∏ß‡∏≤‡∏î Text Footer
            ctx.fillStyle = (currentTheme === 'cool') ? 'white' : '#d63031';
            ctx.font = 'bold 40px Mali';
            ctx.textAlign = 'center';
            const title = (currentTheme === 'love') ? "Happy Valentine's" : "CVC-NU 2024";
            ctx.fillText(title, totalW / 2, totalH - 40);
        }

        function drawDecorations(w, h) {
            if (currentTheme === 'none') return;

            const emojis = (currentTheme === 'love') ? ['‚ù§Ô∏è', 'üåπ', 'üíã'] :
                           (currentTheme === 'cute') ? ['üß∏', '‚≠ê', 'üåà'] :
                           ['üòé', '‚ö°', 'üî•']; // cool

            ctx.font = '50px Arial';
            // ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Emoji (‡πÉ‡∏ä‡πâ Seed ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô layout)
            // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏™‡∏∏‡πà‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
            for(let i=0; i<8; i++) {
                const emo = emojis[i % emojis.length];
                // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏ö
                ctx.fillText(emo, 20, 100 + (i*150)); 
                ctx.fillText(emo, w - 60, 100 + (i*150));
            }
        }

        // 3. User Interaction Functions
        function changeLayout(layout, btn) {
            currentLayout = layout;
            updateActiveButton(btn, btn.parentNode);
            renderCanvas();
        }

        function changeTheme(theme, btn) {
            currentTheme = theme;
            updateActiveButton(btn, btn.parentNode);
            renderCanvas();
        }

        function updateActiveButton(target, parent) {
            parent.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            target.classList.add('active');
        }

        // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á GIF (‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á)
        function createGIF() {
            const images = photos.map(c => c.toDataURL());
            gifshot.createGIF({
                images: images,
                interval: 0.5,
                gifWidth: 320,
                numFrames: 10
            }, function(obj) {
                if(!obj.error) {
                    generatedGIFBlob = obj.image; // ‡πÄ‡∏Å‡πá‡∏ö Base64 GIF ‡πÑ‡∏ß‡πâ‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
                }
            });
        }

        // 5. Upload Process (Upload Image -> Upload GIF -> Show QR)
        async function uploadFiles() {
            if (!generatedGIFBlob) { alert("‡∏£‡∏≠ GIF ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà..."); return; }
            
            btnUpload.disabled = true;
            qrArea.style.display = 'block';
            statusText.innerText = "1/2 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...";

            try {
                // 5.1 Upload PNG
                const pngData = canvas.toDataURL('image/png');
                const resImg = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: pngData, type: 'png' })
                });
                const dataImg = await resImg.json();

                // 5.2 Upload GIF
                statusText.innerText = "2/2 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î GIF...";
                const resGif = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: generatedGIFBlob, type: 'gif' })
                });
                const dataGif = await resGif.json();

                // 5.3 Generate QR (‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏•‡∏±‡∏Å)
                if (dataImg.url && dataGif.url) {
                    statusText.innerText = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!";
                    statusText.style.color = "green";
                    statusText.style.animation = "none";
                    
                    document.getElementById('qrcode').innerHTML = "";
                    new QRCode(document.getElementById('qrcode'), {
                        text: dataImg.url, // QR ‡∏ä‡∏µ‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏£‡∏π‡∏õ
                        width: 150, height: 150
                    });

                    // ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏¢‡∏Å
                    document.getElementById('link-buttons').style.display = 'flex';
                    document.getElementById('dl-img').href = dataImg.url;
                    document.getElementById('dl-gif').href = dataGif.url;
                }

            } catch (err) {
                console.error(err);
                statusText.innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
                btnUpload.disabled = false;
            }
        }

        function resetBooth() {
            location.reload();
        }
    </script>
</body>
</html>
