<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentine Photo Booth</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gifshot/0.3.2/gifshot.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mali:wght@400;700&family=Kanit:wght@300;500&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #ff7675; --bg: #ffeaa7; --panel: #fff; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        h1 { font-family: 'Mali', cursive; color: #d63031; text-shadow: 2px 2px 0 white; margin-bottom: 10px; }

        /* Camera Area */
        .stage { background: #000; border-radius: 15px; overflow: hidden; position: relative; width: 100%; max-width: 480px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        video { width: 100%; height: auto; transform: scaleX(-1); display: block; }
        
        /* Editor Area */
        #editor-area { display: none; background: white; padding: 20px; border-radius: 15px; max-width: 600px; width: 100%; box-shadow: 0 10px 20px rgba(0,0,0,0.1); flex-direction: column; align-items: center; }
        
        canvas { max-width: 100%; height: auto; border: 2px solid #eee; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* Toolbars */
        .tool-section { border-bottom: 1px dashed #ddd; padding-bottom: 15px; margin-bottom: 15px; width: 100%; text-align: center; }
        .label { font-size: 1rem; color: #d63031; display: block; margin-bottom: 8px; font-weight: bold; font-family: 'Mali'; }

        .toolbar { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
        
        button { border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-family: 'Kanit'; font-size: 0.9rem; transition: 0.2s; background: #eee; color: #555; }
        button:hover { background: #ddd; }
        button.active { background: var(--primary); color: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(255, 118, 117, 0.4); }
        
        .action-btn { width: 100%; font-size: 1.2rem; padding: 12px; margin-top: 10px; border-radius: 12px; font-family: 'Mali'; font-weight: bold; }
        .btn-capture { background: #d63031; color: white; }
        .btn-save { background: #00b894; color: white; }
        .btn-reset { background: #636e72; color: white; }

        /* QR Area */
        #qr-area { display: none; margin-top: 20px; text-align: center; background: #f5f6fa; padding: 20px; border-radius: 15px; width: 100%; box-sizing: border-box; }
        #qrcode { display: flex; justify-content: center; margin-bottom: 15px; padding: 10px; background: white; border-radius: 10px; width: fit-content; margin: 0 auto 15px auto; }
        
        .qr-switcher { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .qr-btn { background: white; border: 2px solid #ddd; color: #333; }
        .qr-btn.active { border-color: #0984e3; color: #0984e3; background: #e1f0ff; }

        .status { font-size: 0.9rem; color: #d63031; margin-top: 10px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 8rem; color: white; font-family: 'Mali'; text-shadow: 0 0 20px black; display: none; z-index: 20; }
    </style>
</head>
<body>

    <h1>üì∏ Valentine Photobooth</h1>

    <div id="camera-page" class="stage">
        <video id="video" autoplay playsinline></video>
        <div id="countdown">3</div>
        <div style="position:absolute; bottom:20px; width:100%; text-align:center;">
            <button class="btn-capture action-btn" onclick="startCameraSequence()" style="width:80%; box-shadow: 0 5px 0 #b71c1c;">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏•‡∏¢! (4 ‡∏ä‡πá‡∏≠‡∏ï)</button>
        </div>
    </div>

    <div id="editor-area">
        <canvas id="final-canvas"></canvas>

        <div class="tool-section">
            <span class="label">üé® 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (Layout)</span>
            <div class="toolbar">
                <button onclick="changeLayout('strip4', this)" class="active">4 ‡∏ä‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏ß</button>
                <button onclick="changeLayout('grid4', this)">‡∏ï‡∏≤‡∏£‡∏≤‡∏á 4</button>
                <button onclick="changeLayout('strip3', this)">3 ‡∏ä‡πà‡∏≠‡∏á‡∏¢‡∏≤‡∏ß</button>
                <button onclick="changeLayout('cut2', this)">2 ‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏π‡πà</button>
            </div>
        </div>

        <div class="tool-section">
            <span class="label">üß∏ 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏µ‡∏° (Theme)</span>
            <div class="toolbar">
                <button onclick="changeTheme('none', this)" class="active">‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</button>
                <button onclick="changeTheme('love', this)">‡∏ß‡∏≤‡πÄ‡∏•‡∏ô‡πÑ‡∏ó‡∏ô‡πå üíñ</button>
                <button onclick="changeTheme('cute', this)">‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å üåà</button>
                <button onclick="changeTheme('cool', this)">‡πÄ‡∏ó‡πà‡πÜ üòé</button>
            </div>
        </div>

        <button id="btn-upload" class="btn-save action-btn" onclick="uploadFiles()">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô & ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code</button>
        <button class="btn-reset action-btn" onclick="resetBooth()" style="margin-top:10px;">üîÑ ‡∏ñ‡πà‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà</button>

        <div id="qr-area">
            <p style="margin-bottom:10px; font-weight:bold; color:#333;">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î:</p>
            
            <div class="qr-switcher" id="qr-switcher" style="display:none;">
                <button class="qr-btn active" onclick="showQR('img', this)">üñºÔ∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</button>
                <button class="qr-btn" onclick="showQR('gif', this)">üéûÔ∏è GIF ‡∏î‡∏∏‡πä‡∏Å‡∏î‡∏¥‡πä‡∏Å</button>
            </div>

            <div id="qrcode"></div>
            <p id="status-text" class="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
    </div>

    <script>
        // ===============================================
        // ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö (Text Config)
        // ===============================================
        const TEXT_VALENTINE = "ROOTED IN LOVE 2026";  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡∏ß‡∏≤‡πÄ‡∏•‡∏ô‡πÑ‡∏ó‡∏ô‡πå
        const TEXT_NORMAL    = "ROOTED IN LOVE 2026";        // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏µ‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
        // ===============================================

        const video = document.getElementById('video');
        const editorArea = document.getElementById('editor-area');
        const cameraPage = document.getElementById('camera-page');
        const canvas = document.getElementById('final-canvas');
        const ctx = canvas.getContext('2d');
        const countdownEl = document.getElementById('countdown');
        const qrArea = document.getElementById('qr-area');
        const statusText = document.getElementById('status-text');
        const btnUpload = document.getElementById('btn-upload');
        const qrSwitcher = document.getElementById('qr-switcher');

        let photos = [];
        let currentLayout = 'strip4';
        let currentTheme = 'none';
        let generatedGIFBlob = null;
        let finalImageUrl = "";
        let finalGifUrl = "";

        navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } })
            .then(stream => video.srcObject = stream);

        async function startCameraSequence() {
            photos = [];
            for (let i = 0; i < 4; i++) {
                await doCountdown(3);
                photos.push(captureFrame());
                
                const flash = document.createElement('div');
                flash.style.cssText = "position:absolute;top:0;left:0;width:100%;height:100%;background:white;z-index:99;transition:opacity 0.2s;";
                cameraPage.appendChild(flash);
                setTimeout(() => flash.style.opacity = 0, 50);
                setTimeout(() => flash.remove(), 250);

                if (i < 3) await new Promise(r => setTimeout(r, 1000));
            }
            createGIF(); 
            cameraPage.style.display = 'none';
            editorArea.style.display = 'flex';
            renderCanvas();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function captureFrame() {
            const tCanvas = document.createElement('canvas');
            tCanvas.width = video.videoWidth;
            tCanvas.height = video.videoHeight;
            const tCtx = tCanvas.getContext('2d');
            tCtx.translate(tCanvas.width, 0);
            tCtx.scale(-1, 1);
            tCtx.drawImage(video, 0, 0);
            return tCanvas;
        }

        function doCountdown(sec) {
            return new Promise(resolve => {
                countdownEl.style.display = 'block';
                let c = sec;
                countdownEl.innerText = c;
                const timer = setInterval(() => {
                    c--;
                    if (c > 0) countdownEl.innerText = c;
                    else { clearInterval(timer); countdownEl.style.display = 'none'; resolve(); }
                }, 1000);
            });
        }

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û (Editor) ---
        function renderCanvas() {
            const padding = 30;
            const gap = 15;
            const imgW = 640;
            const imgH = 480;
            
            let totalW, totalH;

            if (currentLayout === 'strip4') {
                totalW = imgW + (padding * 2);
                totalH = (imgH * 4) + (gap * 3) + (padding * 2) + 120; 
            } else if (currentLayout === 'grid4') {
                totalW = (imgW * 2) + gap + (padding * 2);
                totalH = (imgH * 2) + gap + (padding * 2) + 120;
            } else if (currentLayout === 'strip3') {
                totalW = imgW + (padding * 2);
                totalH = (imgH * 3) + (gap * 2) + (padding * 2) + 120;
            } else if (currentLayout === 'cut2') {
                totalW = imgW + (padding * 2);
                totalH = (imgH * 2) + gap + (padding * 2) + 120;
            }

            canvas.width = totalW;
            canvas.height = totalH;

            // 1. ‡∏•‡∏á‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (Layer 1: ‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î)
            ctx.fillStyle = (currentTheme === 'love') ? '#ffcccc' : 
                            (currentTheme === 'cool') ? '#2d3436' :
                            (currentTheme === 'cute') ? '#ffeaa7' : 'white';
            ctx.fillRect(0, 0, totalW, totalH);

            // ‚ùå ‡∏¢‡πâ‡∏≤‡∏¢ Decorations (Emoji) ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
            // drawDecorations(totalW, totalH); 

            // 2. ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Layer 2: ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á)
            photos.forEach((img, i) => {
                let x, y;
                if (currentLayout === 'strip4') {
                    x = padding; y = padding + (i * (imgH + gap));
                } else if (currentLayout === 'grid4') {
                    let row = Math.floor(i / 2);
                    let col = i % 2;
                    x = padding + (col * (imgW + gap)); y = padding + (row * (imgH + gap));
                } else if (currentLayout === 'strip3') {
                    if (i > 2) return;
                    x = padding; y = padding + (i * (imgH + gap));
                } else if (currentLayout === 'cut2') {
                    if (i > 1) return;
                    x = padding; y = padding + (i * (imgH + gap));
                }

                ctx.fillStyle = 'white';
                ctx.fillRect(x - 5, y - 5, imgW + 10, imgH + 10);
                ctx.drawImage(img, x, y, imgW, imgH);
            });

            // ‚úÖ 3. ‡∏ß‡∏≤‡∏î Decorations (Emoji) ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÅ‡∏ó‡∏ô (Layer 3: ‡∏ö‡∏ô‡∏™‡∏∏‡∏î)
            // ‡∏ß‡∏≤‡∏î‡∏ó‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
            drawDecorations(totalW, totalH);

            // 4. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á (Layer 4: ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏ß‡πà‡∏≤)
            ctx.fillStyle = (currentTheme === 'cool') ? 'white' : '#d63031';
            ctx.font = 'bold 40px Mali';
            ctx.textAlign = 'center';
            
            // --- ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á ---
            const title = (currentTheme === 'love') ? TEXT_VALENTINE : TEXT_NORMAL;
            // ------------------------------------
            
            ctx.fillText(title, totalW / 2, totalH - 50);
            ctx.font = '20px Kanit';
            ctx.fillText(new Date().toLocaleDateString('th-TH'), totalW / 2, totalH - 20);
        }

        function drawDecorations(w, h) {
            if (currentTheme === 'none') return;

            const emojis = (currentTheme === 'love') ? ['üíê', 'üíñ', 'ü•∞'] :
                           (currentTheme === 'cute') ? ['üß∏', '‚≠ê', 'üåà'] :
                           ['üòé', '‚ö°', 'üî•'];

            ctx.font = '50px Arial';
            const steps = Math.floor(h / 150); 

            for(let i=0; i < steps; i++) {
                const emo = emojis[i % emojis.length];
                // ‡∏ß‡∏≤‡∏î Emoji ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
                if (i % 2 === 0) {
                     ctx.fillText(emo, 20, 100 + (i*150)); 
                } else {
                     ctx.fillText(emo, w - 70, 100 + (i*150));
                }
            }
        }

        function createGIF() {
            const images = photos.map(c => c.toDataURL());
            gifshot.createGIF({
                images: images,
                interval: 0.5,
                gifWidth: 320,
                numFrames: 10
            }, function(obj) {
                if(!obj.error) { generatedGIFBlob = obj.image; }
            });
        }

        async function uploadFiles() {
            if (!generatedGIFBlob) { alert("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• GIF... ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
            
            btnUpload.disabled = true;
            qrArea.style.display = 'block';
            qrArea.scrollIntoView({ behavior: 'smooth' });
            statusText.innerText = "1/2 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...";

            try {
                const pngData = canvas.toDataURL('image/png');
                const resImg = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: pngData, type: 'png' })
                });
                const dataImg = await resImg.json();
                finalImageUrl = dataImg.url;

                statusText.innerText = "2/2 ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î GIF...";
                const resGif = await fetch('/api/upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: generatedGIFBlob, type: 'gif' })
                });
                const dataGif = await resGif.json();
                finalGifUrl = dataGif.url;

                if (finalImageUrl && finalGifUrl) {
                    statusText.innerText = "‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!";
                    statusText.style.color = "green";
                    statusText.style.animation = "none";
                    qrSwitcher.style.display = "flex"; 
                    generateQR(finalImageUrl);
                }

            } catch (err) {
                console.error(err);
                statusText.innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î";
                btnUpload.disabled = false;
            }
        }

        function showQR(type, btn) {
            document.querySelectorAll('.qr-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            if (type === 'img') generateQR(finalImageUrl);
            else if (type === 'gif') generateQR(finalGifUrl);
        }

        function generateQR(url) {
            const container = document.getElementById('qrcode');
            container.innerHTML = "";
            new QRCode(container, {
                text: url,
                width: 180,
                height: 180
            });
        }

        function changeLayout(layout, btn) {
            currentLayout = layout;
            updateActiveButton(btn);
            renderCanvas();
        }

        function changeTheme(theme, btn) {
            currentTheme = theme;
            updateActiveButton(btn);
            renderCanvas();
        }

        function updateActiveButton(btn) {
            btn.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function resetBooth() {
            location.reload();
        }
    </script>
</body>
</html>
